name: Build WordPress plugin (directory zip)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure packaging tools
        run: sudo apt-get update && sudo apt-get install -y rsync zip

      - name: Create plugin build directory + zip
        shell: bash
        run: |
          set -euo pipefail

          PLUGIN_SLUG="pressify"
          BUILD_ROOT="${GITHUB_WORKSPACE}/build"
          BUILD_DIR="${BUILD_ROOT}/${PLUGIN_SLUG}"
          ZIP_PATH="${BUILD_ROOT}/${PLUGIN_SLUG}.zip"

          rm -rf "${BUILD_ROOT}"
          mkdir -p "${BUILD_DIR}"

          # Copy repository contents into a clean plugin directory,
          # excluding files/folders listed in .distignore.
          rsync -rc --delete \
            --exclude-from="${GITHUB_WORKSPACE}/.distignore" \
            "${GITHUB_WORKSPACE}/" \
            "${BUILD_DIR}/"

          # Ensure the zip root folder is the plugin slug (pressify/...)
          rm -f "${ZIP_PATH}"
          (cd "${BUILD_ROOT}" && zip -r "${PLUGIN_SLUG}.zip" "${PLUGIN_SLUG}")

          echo "Created build at: ${ZIP_PATH}"

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: pressify-${{ github.sha }}
          path: build/pressify.zip
          if-no-files-found: error
          retention-days: 14
